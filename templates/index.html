<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Enterprise Doc Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link href="/static/style.css" rel="stylesheet" />
</head>

<body class="vibrant-bg">

<header class="app-header glass">
  <div class="brand">
    <span class="logo">ðŸ’¬</span>
    <h1>Enterprise Doc Chat</h1>
  </div>
</header>

<main class="container">

  <!-- ============== CHAT ONLY ============== -->
  <section id="tab-chat" class="tab-panel active">
    <div class="card glass strong-shadow">
      <h2>ðŸ“„ Chat with Your Documents</h2>
      <p class="muted">Upload files â†’ Vectorize â†’ Ask anything (powered by FAISS + RAG)</p>

      <!-- INDEX FORM -->
      <form id="form-chat-index" class="form-grid" onsubmit="return false;">

        <div class="field">
          <label for="chat-files">Upload documents</label>
          <input id="chat-files" type="file" multiple accept=".pdf,.docx,.txt" />
          <small class="help">Upload multiple documents at once</small>
        </div>

        <div class="grid-3">
          <div class="field">
            <label for="chat-session">Session ID (optional)</label>
            <input id="chat-session" type="text" placeholder="Auto-generated if empty" />
          </div>

          <div class="field">
            <label for="chat-chunk">Chunk Size</label>
            <input id="chat-chunk" type="number" value="1000" min="200" />
          </div>

          <div class="field">
            <label for="chat-overlap">Chunk Overlap</label>
            <input id="chat-overlap" type="number" value="200" min="0" />
          </div>
        </div>

        <div class="grid-3">
          <div class="field">
            <label for="chat-k">Top-K</label>
            <input id="chat-k" type="number" value="5" min="1" max="20" />
          </div>

          <div class="field toggle-row">
            <label>Use Session-Based Indexing</label>
            <label class="switch">
              <input id="chat-sessionized" type="checkbox" checked />
              <span class="slider"></span>
            </label>
          </div>
        </div>

        <div class="actions">
          <button id="btn-build" class="btn primary big">Build / Update Index</button>
        </div>
      </form>

      <div id="chat-meta" class="muted small"></div>

      <div class="divider"></div>

      <!-- QUESTION FORM -->
      <form id="form-chat-ask" class="form-grid" onsubmit="return false;">
        <div class="field">
          <label for="chat-q">Your Question</label>
          <input id="chat-q" type="text" placeholder="Ask anything about your uploaded documentsâ€¦" />
        </div>
        <div class="actions">
          <button id="btn-ask" class="btn">Send</button>
        </div>
      </form>

      <div id="chat-ans" class="result-block">
        <h3>Answer</h3>
        <div class="answer" id="chat-answer">No answer yet.</div>
      </div>

    </div>
  </section>
</main>

<footer class="app-footer glass">
  <div>Â© Enterprise Doc Chat</div>
  <div class="tiny">Powered by FAISS + FastAPI</div>
</footer>


<script>
/* SAME JS as before â€“ only chat logic kept */
const API_BASE = "";

let currentSession = null;

document.getElementById("btn-build").addEventListener("click", async () => {
  const files     = document.getElementById("chat-files").files;
  const sessionId = document.getElementById("chat-session").value.trim();
  const useSess   = document.getElementById("chat-sessionized").checked;
  const k         = +document.getElementById("chat-k").value || 5;
  const chunk     = +document.getElementById("chat-chunk").value || 1000;
  const overlap   = +document.getElementById("chat-overlap").value || 200;
  const meta      = document.getElementById("chat-meta");

  if (!files.length) { meta.textContent = "Please upload at least one file."; return; }

  try {
    meta.textContent = "Building indexâ€¦";

    const fd = new FormData();
    [...files].forEach(f => fd.append("files", f));
    if (sessionId) fd.append("session_id", sessionId);
    fd.append("use_session_dirs", useSess ? "true" : "false");
    fd.append("chunk_size", chunk);
    fd.append("chunk_overlap", overlap);
    fd.append("k", k);

    const res = await fetch(`${API_BASE}/chat/index`, { method: "POST", body: fd });
    const json = await res.json();

    currentSession = json.session_id || sessionId || null;
    meta.textContent = `Indexed. session=${currentSession}, k=${json.k}`;
  }
  catch (e) {
    meta.textContent = "Indexing failed: " + e.message;
  }
});


document.getElementById("btn-ask").addEventListener("click", async () => {
  const q        = document.getElementById("chat-q").value.trim();
  const ans      = document.getElementById("chat-answer");
  const useSess  = document.getElementById("chat-sessionized").checked;
  const k        = +document.getElementById("chat-k").value || 5;

  if (!q) { ans.textContent = "Please enter a question."; return; }
  if (useSess && !currentSession) {
    ans.textContent = "Build the index first.";
    return;
  }

  try {
    ans.textContent = "Thinkingâ€¦";

    const fd = new FormData();
    fd.append("question", q);
    fd.append("use_session_dirs", useSess ? "true" : "false");
    fd.append("k", k);
    if (useSess && currentSession) fd.append("session_id", currentSession);

    const res = await fetch(`${API_BASE}/chat/query`, { method: "POST", body: fd });
    const json = await res.json();

    ans.textContent = json.answer || "No response";
  }
  catch (e) {
    ans.textContent = "Error: " + e.message;
  }
});
</script>

</body>
</html>
